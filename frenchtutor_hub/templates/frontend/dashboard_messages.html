{% extends "frontend/dashboard_base.html" %}
{% load static %}

{% block dashboard_title %}Messages{% endblock %}

{% block dashboard_content %}
<div class="messaging-container">
    <div class="row h-100">
        <!-- Conversation list sidebar -->
        <div class="col-md-4 col-lg-3 border-right conversation-list">
            <div class="px-4 py-3 bg-light">
                <h5 class="mb-0">Conversations</h5>
            </div>
            <div class="conversation-search p-2">
                <input type="text" class="form-control" placeholder="Search conversations..." id="conversation-search">
            </div>
            <div class="conversations-list" id="conversations-container">
                <!-- Conversations will be loaded here via JavaScript -->
                <div class="text-center py-4 text-muted" id="empty-conversations-message">
                    <div class="mb-3">
                        <i class="fas fa-comments fa-3x"></i>
                    </div>
                    <p>No conversations yet</p>
                </div>
            </div>
        </div>

        <!-- Message thread -->
        <div class="col-md-8 col-lg-9 message-thread">
            <div id="no-conversation-selected" class="text-center py-5 d-flex flex-column align-items-center justify-content-center h-100">
                <div class="mb-4">
                    <i class="fas fa-comment-dots fa-4x text-muted"></i>
                </div>
                <h4>Select a conversation</h4>
                <p class="text-muted">Choose a conversation from the list or start a new one</p>
                <button class="btn btn-primary mt-3" id="new-conversation-btn">
                    <i class="fas fa-plus me-2"></i> New Conversation
                </button>
            </div>
            
            <div id="conversation-view" class="h-100 d-none">
                <div class="chat-header px-4 py-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="" class="rounded-circle me-2 participant-avatar" width="40" height="40" alt="">
                        <div>
                            <h5 class="mb-0 participant-name"></h5>
                            <small class="text-muted participant-status"></small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="btn btn-sm btn-outline-secondary me-2 d-none d-md-inline-block">
                            <i class="fas fa-video me-1"></i> Call
                        </button>
                        <button class="btn btn-sm btn-outline-secondary conversation-options-btn">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages p-4" id="messages-container">
                    <!-- Messages will be loaded here via JavaScript -->
                </div>
                
                <div class="chat-input border-top p-3">
                    <form id="message-form" class="d-flex align-items-center">
                        <input type="hidden" id="conversation-id" value="">
                        <input type="text" class="form-control me-2" id="message-input" placeholder="Type a message...">
                        <button type="button" class="btn btn-link text-decoration-none me-2" id="attach-file-btn">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Conversation Modal -->
<div class="modal fade" id="new-conversation-modal" tabindex="-1" aria-labelledby="new-conversation-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="new-conversation-modal-label">New Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="recipient-select" class="form-label">Select Recipient</label>
                    <select class="form-select" id="recipient-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="first-message" class="form-label">First Message</label>
                    <textarea class="form-control" id="first-message" rows="3" placeholder="Type your first message..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-conversation-btn">Start Conversation</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Store current user ID from backend
    const currentUserId = {{ current_user_id }};
    
    // API endpoints
    const API = {
        conversations: '/api/messaging/conversations/',
        messages: '/api/messaging/messages/',
        users: '/api/messaging/users/'
    };
    
    // Fetch conversations
    function fetchConversations() {
        fetch(API.conversations, {
            headers: {
                'Authorization': `Bearer ${getToken()}`
            }
        })
        .then(response => response.json())
        .then(data => {
            renderConversations(data);
        })
        .catch(error => {
            console.error('Error fetching conversations:', error);
        });
    }
    
    // Render conversations list
    function renderConversations(conversations) {
        const container = document.getElementById('conversations-container');
        const emptyMessage = document.getElementById('empty-conversations-message');
        
        if (conversations.length === 0) {
            emptyMessage.classList.remove('d-none');
            return;
        }
        
        emptyMessage.classList.add('d-none');
        container.innerHTML = '';
        
        conversations.forEach(conversation => {
            // Determine the other participant (not the current user)
            const otherParticipant = conversation.participants.find(p => p.id !== currentUserId);
            
            const lastMessage = conversation.last_message || {
                content: 'No messages yet',
                created_at: conversation.created_at,
                sender_id: null
            };
            
            const unreadBadge = conversation.unread_count > 0 
                ? `<span class="badge bg-primary rounded-pill ms-1">${conversation.unread_count}</span>` 
                : '';
            
            const lastMessageTime = formatTimestamp(lastMessage.created_at);
            
            const html = `
                <div class="conversation-item p-3 ${conversation.id === activeConversationId ? 'active' : ''}" 
                     data-conversation-id="${conversation.id}"
                     data-participant-id="${otherParticipant.id}"
                     data-participant-name="${otherParticipant.name || otherParticipant.username}">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <img src="${otherParticipant.avatar || '/static/img/default-avatar.png'}" class="rounded-circle" 
                                 width="48" height="48" alt="${otherParticipant.username}">
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0">${otherParticipant.name || otherParticipant.username} ${unreadBadge}</h6>
                                <small class="text-muted">${lastMessageTime}</small>
                            </div>
                            <p class="text-truncate mb-0 small text-muted">
                                ${lastMessage.sender_id === currentUserId ? 'You: ' : ''}
                                ${lastMessage.content}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += html;
        });
        
        // Add click event listeners to conversation items
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.addEventListener('click', function() {
                const conversationId = this.getAttribute('data-conversation-id');
                const participantId = this.getAttribute('data-participant-id');
                const participantName = this.getAttribute('data-participant-name');
                
                loadConversation(conversationId, participantId, participantName);
                
                // Update active state
                document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }
    
    // Global variable to store active conversation ID
    let activeConversationId = null;
    
    // Load a conversation
    function loadConversation(conversationId, participantId, participantName) {
        activeConversationId = conversationId;
        
        // Update UI to show conversation view
        document.getElementById('no-conversation-selected').classList.add('d-none');
        document.getElementById('conversation-view').classList.remove('d-none');
        
        // Update conversation header
        document.querySelector('.participant-name').textContent = participantName;
        document.getElementById('conversation-id').value = conversationId;
        
        // Fetch messages for this conversation
        fetchMessages(conversationId);
    }
    
    // Fetch messages for a conversation
    function fetchMessages(conversationId) {
        fetch(`${API.conversations}${conversationId}/messages/`, {
            headers: {
                'Authorization': `Bearer ${getToken()}`
            }
        })
        .then(response => response.json())
        .then(data => {
            renderMessages(data);
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
        });
    }
    
    // Render messages in conversation
    function renderMessages(messages) {
        const container = document.getElementById('messages-container');
        container.innerHTML = '';
        
        if (messages.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <p>No messages yet</p>
                    <p>Send a message to start the conversation</p>
                </div>
            `;
            return;
        }
        
        let lastDate = null;
        
        messages.forEach(message => {
            const messageDate = new Date(message.created_at).toLocaleDateString();
            
            // Add date separator if this is a new day
            if (lastDate !== messageDate) {
                container.innerHTML += `
                    <div class="message-date-separator my-3">
                        <span class="badge bg-light text-dark px-3 py-2">${messageDate}</span>
                    </div>
                `;
                lastDate = messageDate;
            }
            
            const isCurrentUser = message.sender.id === currentUserId;
            const messageTime = new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const html = `
                <div class="message ${isCurrentUser ? 'message-out' : 'message-in'} mb-3">
                    <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}">
                        ${!isCurrentUser ? `
                            <div class="flex-shrink-0 me-2">
                                <img src="${message.sender.avatar || '/static/img/default-avatar.png'}" class="rounded-circle" 
                                     width="32" height="32" alt="${message.sender.username}">
                            </div>
                        ` : ''}
                        <div class="message-body ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} p-3 rounded-3">
                            ${message.content}
                            <div class="message-time small ${isCurrentUser ? 'text-white-50' : 'text-muted'} mt-1">
                                ${messageTime}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += html;
        });
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }
    
    // Send a message
    function sendMessage(conversationId, content) {
        fetch(API.messages, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            // Add the new message to the conversation
            const messagesContainer = document.getElementById('messages-container');
            const messageTime = new Date(data.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const html = `
                <div class="message message-out mb-3">
                    <div class="d-flex justify-content-end">
                        <div class="message-body bg-primary text-white p-3 rounded-3">
                            ${data.content}
                            <div class="message-time small text-white-50 mt-1">
                                ${messageTime}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.innerHTML += html;
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Refresh conversations list to update last message
            fetchConversations();
        })
        .catch(error => {
            console.error('Error sending message:', error);
        });
    }
    
    // Start a new conversation
    function startNewConversation(recipientId, firstMessage) {
        fetch(API.conversations, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({
                participant_id: recipientId,
                message: firstMessage
            })
        })
        .then(response => response.json())
        .then(data => {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('new-conversation-modal'));
            modal.hide();
            
            // Reset form fields
            document.getElementById('recipient-select').value = '';
            document.getElementById('first-message').value = '';
            
            // Refresh conversations list
            fetchConversations();
            
            // Load the new conversation
            const participant = data.participants.find(p => p.id !== currentUserId);
            loadConversation(data.id, participant.id, participant.name || participant.username);
        })
        .catch(error => {
            console.error('Error starting conversation:', error);
        });
    }
    
    // Load available users for new conversation
    function loadAvailableUsers() {
        fetch(API.users, {
            headers: {
                'Authorization': `Bearer ${getToken()}`
            }
        })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('recipient-select');
            select.innerHTML = '';
            
            if (data.length === 0) {
                select.innerHTML = '<option value="">No users available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select a user</option>';
            data.forEach(user => {
                if (user.id !== currentUserId) {
                    select.innerHTML += `<option value="${user.id}">${user.name || user.username}</option>`;
                }
            });
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
    }
    
    // Helper function to format timestamps
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        
        // If today, show time only
        if (date.toDateString() === now.toDateString()) {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // If this year, show month and day
        if (date.getFullYear() === now.getFullYear()) {
            return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }
        
        // Otherwise show full date
        return date.toLocaleDateString();
    }
    
    // Get token from various storage options
    function getToken() {
        // Try session storage
        let token = sessionStorage.getItem('access_token');
        
        // Try local storage if not in session
        if (!token) {
            token = localStorage.getItem('access_token');
        }
        
        // Default to any token provided by Django in the template
        if (!token) {
            token = '{{ request.session.access_token }}';
        }
        
        return token;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load conversations
        fetchConversations();
        
        // Set up message form submission
        document.getElementById('message-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const conversationId = document.getElementById('conversation-id').value;
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            sendMessage(conversationId, content);
            messageInput.value = '';
        });
        
        // Set up new conversation button
        document.getElementById('new-conversation-btn').addEventListener('click', function() {
            loadAvailableUsers();
            const modal = new bootstrap.Modal(document.getElementById('new-conversation-modal'));
            modal.show();
        });
        
        // Set up start conversation button
        document.getElementById('start-conversation-btn').addEventListener('click', function() {
            const recipientId = document.getElementById('recipient-select').value;
            const firstMessage = document.getElementById('first-message').value.trim();
            
            if (!recipientId || !firstMessage) {
                alert('Please select a recipient and enter a message');
                return;
            }
            
            startNewConversation(recipientId, firstMessage);
        });
        
        // Search functionality for conversations
        document.getElementById('conversation-search').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.conversation-item').forEach(item => {
                const participantName = item.getAttribute('data-participant-name').toLowerCase();
                if (participantName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Poll for new messages every 10 seconds
        setInterval(() => {
            if (activeConversationId) {
                fetchMessages(activeConversationId);
            }
            fetchConversations();
        }, 10000);
    });
</script>

<style>
    /* Custom styles for the messaging interface */
    .messaging-container {
        height: calc(100vh - 120px);
        min-height: 500px;
    }
    
    .conversation-list {
        height: 100%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
    }
    
    .conversation-item {
        cursor: pointer;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: background-color 0.2s;
    }
    
    .conversation-item:hover, .conversation-item.active {
        background-color: rgba(0,0,0,0.03);
    }
    
    .message-thread {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    #conversation-view {
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
    }
    
    .message-date-separator {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .message-body {
        max-width: 80%;
        word-break: break-word;
    }
    
    .message-in .message-body {
        border-top-left-radius: 0 !important;
    }
    
    .message-out .message-body {
        border-top-right-radius: 0 !important;
    }
    
    @media (max-width: 767.98px) {
        .messaging-container {
            height: calc(100vh - 80px);
        }
        
        .message-body {
            max-width: 90%;
        }
    }
</style>
{% endblock %}
